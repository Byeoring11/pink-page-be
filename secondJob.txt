import shlex
import subprocess
from pathlib import Path
from typing import Optional

def scp_sync(
    src: str,
    dst: str,
    *,
    port: int = 22,
    identity_file: Optional[Path] = None,
    password: Optional[str] = None,
    extra_opts: Optional[list[str]] = None,
) -> int:
    """
    로컬에서 `scp` 명령을 실행한다.
    - src, dst 는 `user@host:/path` 혹은 로컬 경로 형식.
    - `identity_file` 은 `-i` 옵션에 전달할 개인키 파일.
    - `password` 가 있으면 `sshpass -p <pwd>` 로 감싼다.
    - 반환값: scp 프로세스의 exit code (0이면 성공)
    """
    # 기본 옵션
    opts = ["-P", str(port), "-o", "StrictHostKeyChecking=no"]
    if identity_file:
        opts += ["-i", str(identity_file)]

    if extra_opts:
        opts += extra_opts

    # 최종 명령 라인 (리스트 형태)
    cmd = ["scp"] + opts + [src, dst]

    # 비밀번호가 있으면 sshpass 로 감싼다.
    if password:
        # sshpass 가 시스템에 설치돼 있어야 함.
        cmd = ["sshpass", "-p", password] + cmd

    # 디버그용 출력
    print("[DEBUG] 실행 명령:", " ".join(shlex.quote(p) for p in cmd))

    # 실제 실행 (stdout,stderr 를 그대로 콘솔에 출력)
    result = subprocess.run(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,          # 문자열 반환
    )

    # 전체 로그를 화면에 출력 (필요 시 로깅 파일에 저장)
    print(result.stdout)

    return result.returncode

# 원격 → 원격 (비밀번호 인증, sshpass 사용)
scp_sync(
    src="c3100419@172.19.10.143:/nbsftp/myd/myp/snd/postgresql_unload/*.dat",
    dst="c3100419@172.23.248.115:/shbftp/myd/myp/rcv/mock/",
)